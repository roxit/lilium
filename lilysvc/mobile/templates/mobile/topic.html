{% extends "mobile/base.html" %}

{% block title %}
品味文章
{% endblock %}

{% block body %}
<div data-role="page" id="topicPage">

    <script>
        var r = {};

        function extendList(resp) {
            /*
            if (resp.error)
            {
                $.mobile.hidePageLoadingMsg();
                $("#moreButton").html(resp.message);
                return;
            }
            */
            var topic = resp;
            if (!r.nextStart) {
                $("#title").html(topic.postList[0].title);
            }

            $('#postTmpl').tmpl(resp.postList).appendTo($("#postList"));

            if (topic.nextStart) {
                r.nextStart = topic.nextStart;
                $("#moreButton").html("更多");
            } else {
                $("#moreButton").hide();
            }
            $("#postList").listview("refresh");
            $.mobile.hidePageLoadingMsg();
        };

        function loadMore() {
            $.mobile.showPageLoadingMsg();
            $("#moreButton").html("载入中");

            var url = "/api/topic/"+r.board+"/"+r.pid;
            if (r.nextStart)
                url += "/"+r.nextStart;
            $.ajax({
                url: url,
                dataType: 'json',
                success: extendList,
                error: function showError() {

                }
            });
        };

        $("#moreButton").live("click", loadMore);

        $("#topicPage").live("pageinit", function (event) {
            r.board = "{{ board }}";
            r.pid = {{ pid }};
            $("#postList").html("");
            loadMore();
        });
    </script>

    <script id="postTmpl" type="text/x-jquery-tmpl">
        <li class="ui-li ui-li-static ui-body-c">
            <span class="post-author">${author}</span>
            <div class="post-body">
                {% templatetag openbrace %}{% templatetag openbrace %}html body{% templatetag closebrace %}{% templatetag closebrace %}
            </div>
        </li>
    </script>

    <div data-role="header" id="title" class="topic-title">
        <!--<a data-role="button" data-rel="back">后退</a>-->
    </div>
    <div data-role="content">
        <ul data-role="listview" class="ui-listview" data-theme="b" id="postList">
        </ul>
        <div class="pagination">
            <a id="moreButton" data-role="button" href="#">更多</a>
        </div>
    </div>
    <div data-role="footer" data-position="fixed">
        <a href="{% url board  board=board %}" data-icon="home" data-iconpos="notext">返回</a>
        <a href="#" data-icon="add">回复</a>
    </div>
</div>
{% endblock %}
